{% extends "layout.html" %}
{% block title %}Preview — {{ camera_id }}{% endblock %}

{% block content %}
<h1 class="mb-3">Preview — {{ camera_id }}</h1>

<div class="mb-3">
  <div class="d-flex gap-2">
    <button id="btnStart" class="btn btn-primary">Enable Preview</button>
    <button id="btnStop" class="btn btn-outline-secondary">Exit Preview</button>
  </div>
  <div class="form-text">Preview pauses the recorder on the node while active (in the same process).</div>
</div>

<div class="ratio ratio-16x9 border rounded bg-light d-flex align-items-center justify-content-center">
  <img id="stream" alt="preview stream" style="max-width:100%; max-height:100%; object-fit:contain; display:none;">
  <div id="nostream" class="text-muted">Preview not running</div>
</div>

<!-- Sensor panel -->
<div class="mt-3">
  <div class="card">
    <div class="card-body d-flex flex-wrap align-items-center gap-3">
      <div>
        <div class="text-muted small">Distance</div>
        <div id="distVal" class="fs-4">— mm</div>
      </div>
      <div>
        <div class="text-muted small">Threshold</div>
        <div id="threshVal" class="fs-5">— mm</div>
      </div>
      <div class="ms-auto">
        <span id="triggerBadge" class="badge rounded-pill bg-secondary">No data</span>
      </div>
      <div class="w-100"></div>
      <div class="w-100">
        <div class="text-muted small mb-1">Distance vs. Threshold</div>
        <div class="progress" style="height: 8px;">
          <div id="distBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between small text-muted mt-1">
          <span>Closer</span><span>Farther</span>
        </div>
      </div>
    </div>
  </div>
  <div class="form-text mt-1">Live sensor reads from the node (VL53L0X). Updates ~2×/second.</div>
</div>

<script>
const camId = {{ camera_id|tojson }};
const host = {{ (endpoint.ssh_host or '')|tojson }};

async function postJSON(url, body) {
  const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body||{})});
  const data = await res.json().catch(()=> ({}));
  if(!res.ok || !data.ok){ throw new Error((data && (data.error||data.raw)) || res.statusText); }
  return data;
}

let sensorTimer = null;

function setBadge(state) {
  const el = document.getElementById('triggerBadge');
  if (state === 'trigger') { el.className = 'badge rounded-pill bg-danger'; el.textContent = 'Would trigger'; }
  else if (state === 'no-trigger') { el.className = 'badge rounded-pill bg-success'; el.textContent = 'Clear'; }
  else { el.className = 'badge rounded-pill bg-secondary'; el.textContent = 'No data'; }
}

function updateSensorUI(obj) {
  const dEl = document.getElementById('distVal');
  const tEl = document.getElementById('threshVal');
  const bar = document.getElementById('distBar');

  if (!obj || obj.ok === false) {
    dEl.textContent = '— mm';
    tEl.textContent = '— mm';
    bar.style.width = '0%';
    setBadge('no-data');
    return;
  }

  const dist = obj.distance_mm ?? null;
  const thr  = obj.threshold_mm ?? null;
  const would = !!obj.would_trigger;

  dEl.textContent = (dist !== null) ? `${dist} mm` : '— mm';
  tEl.textContent = (thr  !== null) ? `${thr} mm`  : '— mm';

  // Progress: clamp to [0..200% of threshold] so bar stays sensible.
  let pct = 0;
  if (dist !== null && thr && thr > 0) {
    pct = Math.max(0, Math.min(100, Math.round((dist / (thr*2)) * 100)));
  }
  bar.style.width = pct + '%';
  bar.setAttribute('aria-valuenow', pct);
  bar.className = 'progress-bar ' + (would ? 'bg-danger' : 'bg-success');

  setBadge(would ? 'trigger' : 'no-trigger');
}

async function pollSensorOnce() {
  if (!host) { return; }
  try {
    const res = await fetch(`http://${host}:8080/api/live/sensor`, {cache: 'no-cache'});
    const obj = await res.json().catch(()=> ({}));
    updateSensorUI(obj);
  } catch (e) {
    // transient network / CORS / node reboot: just show no-data
    updateSensorUI(null);
  }
}

function startSensorPolling() {
  // Do an immediate read, then poll every 500ms
  pollSensorOnce();
  if (sensorTimer) clearInterval(sensorTimer);
  sensorTimer = setInterval(pollSensorOnce, 500);
}
function stopSensorPolling() {
  if (sensorTimer) clearInterval(sensorTimer);
  sensorTimer = null;
  // Keep last reading on screen; if you prefer to clear, uncomment below line:
  // updateSensorUI(null);
}

async function startPreview() {
  await postJSON('/action/secure/preview/start', {camera_id: camId});
  document.getElementById('stream').src = `http://${host}:8080/api/live/mjpeg?ts=${Date.now()}`;
  document.getElementById('stream').style.display = '';
  document.getElementById('nostream').style.display = 'none';
  startSensorPolling();
}
async function stopPreview() {
  stopSensorPolling();
  await postJSON('/action/secure/preview/stop', {camera_id: camId});
  const img = document.getElementById('stream');
  img.removeAttribute('src');
  document.getElementById('stream').style.display = 'none';
  document.getElementById('nostream').style.display = '';
}

document.getElementById('btnStart').addEventListener('click', async ()=>{
  try { await startPreview(); } catch(e){ alert('Start failed: '+e.message); }
});
document.getElementById('btnStop').addEventListener('click', async ()=>{
  try { await stopPreview(); } catch(e){ alert('Stop failed: '+e.message); }
});

// Optional: if you want sensor data even when preview is not active, uncomment:
// startSensorPolling();
</script>
{% endblock %}
